<script type="text/javascript">
	function redirect(expansion, query) {
		var URL = expansion.replace('__QUERY__', query);
		location.href = URL;
	}

	function getExpansion(shortcutName) {
		var shortcut = JSON.parse(localStorage.getItem('shortcuts') || '{}')[shortcutName];
		var defaults = JSON.parse(localStorage.getItem('defaults') || '{}')[shortcutName];

		if(shortcut) {
			return shortcut;
		} else {
			return defaults;
		}
	}

	function getShortcut(URL) {
		URL = decodeURI(location.hash.slice(1));

		var index = URL.lastIndexOf('!');
		var shortcut, expansion, search;
		var middle = false;

		if(URL.match(/(?:^|\s)(\![a-z]+)(?=\s|$)/i)) {
			shortcut = URL.match(/(?:^|\s)(\![a-z]+)(?=\s|$)/i)[1];
			search = URL.replace(/\s+\![a-z]+\s+/i, ' ');
			middle = true;
		} else {
			shortcut = URL.slice(index);
		}

		expansion = getExpansion(shortcut);
		
		if(index === -1 || !expansion) {
			location.href = 'https://encrypted.google.com/search?hl=en&q=' + URL;
		} else if(expansion) {
			if(middle) {
				redirect(expansion.expansion, search);
			} else {
				redirect(expansion.expansion, URL.slice(0, index));
			}
		}
		
	}
	getShortcut(location.hash.slice(1));
</script>