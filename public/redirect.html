<script type="text/javascript">
	function replace(str, query = '', arr = []) {
		var ret = str;

		(str.match(/{\d+}/g) || []).forEach(function(match) {
			var index = +match.slice(1, -1) -1;

			ret = ret.replace(match, arr[index] || '');
		});

		return ret.replace(/{query}/gi, query);
	}

	function getReplacements(str) {
		var matches = str.match(/(^|\s+)(![a-z]+)([a-z\|]+)?(\s+|$)/i);

		if(!matches) return null;

		var shortcut = matches[2];
		var query = str.replace(matches[0], '');
		var params;

		if(matches[3]) params = matches[3].split('|').slice(1);

		return {shortcut: shortcut, params: params, query: query};
	}

	function getExpansion(shortcutName) {
		var shortcut = JSON.parse(localStorage.getItem('shortcuts') || '{}')[shortcutName];
		var defaultShortcut = JSON.parse(localStorage.getItem('defaults') || '{}')[shortcutName];

		if(shortcut) {
			return shortcut;
		} else if(defaultShortcut) {
			return defaultShortcut;
		} else {
			return null;
		}
	}

	function getSearchURL(query) {
		return JSON.parse(localStorage.getItem('defaultSearch')).URL + query;
	}

	var query = decodeURI(location.hash.slice(1));
	var replacements = getReplacements(query);
	var expansion;

	if(replacements === null) {
		//location.href = getSearchURL(query)
	} else {
		expansion = getExpansion(replacements.shortcut);

		if(expansion === null) {
			//location.href = getSearchURL(query);
		} else {
			//location.href = replace(expansion.expansion, replacements.query, replacements.query, replacements.params)
		}
	}
</script>